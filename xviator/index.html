<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Xviator â€“ Crash Game</title>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            casinoDark: "#0C0A16",
            casinoCard: "#151226",
            casinoPurple: "#A56BFF",
            casinoGlow: "#CFAAFF",
            successGreen: "#28a745",
            errorRed: "#dc3545",
            infoBlue: "#0d6efd"
          },
          fontFamily: { sans: ["Inter", "system-ui"] }
        }
      }
    };
  </script>

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>

  <!-- Lucide -->
  <script defer src="https://unpkg.com/lucide@0.258.0/dist/umd/lucide.js"></script>
</head>

<body class="bg-casinoDark text-white font-sans antialiased">
  <div id="app" class="min-h-screen p-6 pb-24">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <div class="text-lg font-semibold">Xviator</div>
        <div class="text-sm text-gray-400">Crash before it crashes!</div>
      </div>
      <span class="p-2 rounded-full bg-casinoCard shadow">
        <i data-lucide="trending-up" class="text-gray-300"></i>
      </span>
    </div>

    <!-- Bet Input -->
    <div class="bg-casinoCard p-5 rounded-2xl shadow-lg mb-6">
      <label class="text-gray-300 text-sm">Enter Bet Amount (â‚¦)</label>
      <input type="number" v-model="betAmount"
        class="mt-2 w-full p-3 rounded-xl bg-casinoDark border border-gray-700 focus:border-casinoPurple outline-none"
        placeholder="e.g. 1000" />

      <button v-if="!roundStarted" @click="startGame"
        class="w-full mt-5 py-3 rounded-full bg-casinoPurple text-white font-semibold flex items-center justify-center gap-2">
        <i data-lucide="play"></i> Start Round
      </button>

      <button v-if="roundStarted && !cashedOut && !crashed" @click="cashOut"
        class="w-full mt-5 py-3 rounded-full bg-successGreen text-white font-semibold flex items-center justify-center gap-2">
        <i data-lucide="dollar-sign"></i> Cash Out
      </button>

      <button v-if="crashed" @click="resetGame"
        class="w-full mt-5 py-3 rounded-full bg-infoBlue text-white font-semibold flex items-center justify-center gap-2">
        <i data-lucide="rotate-ccw"></i> New Round
      </button>
    </div>

    <!-- Multiplier Display -->
    <div class="bg-casinoCard p-5 rounded-2xl shadow-lg mb-6 text-center">
      <div class="text-6xl font-bold" :class="crashed ? 'text-errorRed' : 'text-casinoPurple'">
        {{ multiplier.toFixed(2) }}x
      </div>
      <div v-if="crashed" class="text-errorRed font-semibold mt-3 text-lg">CRASHED</div>
      <div v-if="cashedOut" class="text-successGreen font-semibold mt-3 text-lg">CASHED OUT!</div>
    </div>

    <!-- Notification -->
    <transition name="fade">
      <div v-if="notification.message"
        :class="['mt-4 p-4 rounded-lg text-white font-medium', notificationColor]">
        {{ notification.message }}
      </div>
    </transition>

  </div>

  <!-- Bottom Navigation -->
  <div class="fixed bottom-0 w-full bg-casinoCard border-t border-gray-700 flex justify-around py-3">
    <a href="/" class="flex flex-col items-center">
      <i data-lucide="home" class="text-gray-400"></i>
      <span class="text-xs text-gray-400 mt-1">Home</span>
    </a>
    <a href="/games" class="flex flex-col items-center">
      <i data-lucide="gamepad-2" class="text-gray-400"></i>
      <span class="text-xs text-gray-400 mt-1">Games</span>
    </a>
    <a href="/deposit" class="flex flex-col items-center">
      <i data-lucide="arrow-big-up" class="text-casinoPurple"></i>
      <span class="text-xs text-casinoPurple mt-1">Deposit</span>
    </a>
    <a href="/profile" class="flex flex-col items-center">
      <i data-lucide="user" class="text-gray-400"></i>
      <span class="text-xs text-gray-400 mt-1">Profile</span>
    </a>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          token: "",
          betAmount: "",
          multiplier: 1.00,
          roundStarted: false,
          crashed: false,
          cashedOut: false,
          crashPoint: 1,
          notification: { message: "", type: "info" },
          interval: null,
        };
      },

      computed: {
        notificationColor() {
          return this.notification.type === "success"
            ? "bg-successGreen"
            : this.notification.type === "error"
              ? "bg-errorRed"
              : "bg-infoBlue";
        }
      },

      mounted() {
        setTimeout(() => lucide.createIcons(), 100);
        this.token = localStorage.getItem("casino_token");
        if (!this.token) {
          alert("Login required");
          window.location.href = "/login";
        }
      },

      methods: {
        /** Start the crash game */
        async startGame() {
          if (!this.betAmount || this.betAmount < 100) {
            return this.showNotification("Enter a valid bet amount (min â‚¦100)", "error");
          }

          // Debit wallet
          const debitPayload = {
            token: this.token,
            amount: Number(this.betAmount),
            reference: "DEBIT" + Date.now(),
            description: "Xviator Bet"
          };

          this.showNotification("Debiting walletâ€¦", "info");

          const debitRes = await fetch("https://favour-amaaavl.xyz/api/fund/sub", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(debitPayload)
          });

          const debitData = await debitRes.json();
          if (!debitData.status) {
            return this.showNotification("Debit failed: " + debitData.message, "error");
          }

          // Start round
          this.roundStarted = true;
          this.cashedOut = false;
          this.crashed = false;
          this.multiplier = 1.00;

          // Determine crash point (Aviator formula style)
          this.crashPoint = (Math.random() * 20 + 1).toFixed(2);

          this.runMultiplier();
        },

        /** Multiplier increases until crash */
        runMultiplier() {
          this.interval = setInterval(() => {
            if (this.cashedOut) return;

            this.multiplier += 0.03 + this.multiplier * 0.015;

            if (this.multiplier >= this.crashPoint) {
              this.triggerCrash();
            }
          }, 80);
        },

        /** Crash event */
        triggerCrash() {
          clearInterval(this.interval);
          this.crashed = true;
          this.roundStarted = false;
          this.showNotification("Round crashed at " + this.multiplier.toFixed(2) + "x", "error");
        },

        /** Cash out before crash */
        async cashOut() {
          this.cashedOut = true;
          clearInterval(this.interval);

          const winAmount = Number(this.betAmount) * this.multiplier;

          const creditPayload = {
            token: this.token,
            amount: winAmount,
            reference: "CREDIT" + Date.now(),
            description: `Xviator Cashout ${this.multiplier.toFixed(2)}x`
          };

          const creditRes = await fetch("https://favour-amaaavl.xyz/api/fund/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(creditPayload)
          });

          const creditData = await creditRes.json();

          if (creditData.status) {
            this.showNotification(`ðŸŽ‰ You won â‚¦${winAmount.toFixed(2)}!`, "success");
          } else {
            this.showNotification("Credit failed: " + creditData.message, "error");
          }
        },

        /** Reset UI for next round */
        resetGame() {
          this.multiplier = 1.00;
          this.crashed = false;
          this.cashedOut = false;
          this.roundStarted = false;
        },

        /** Notification system */
        showNotification(message, type) {
          this.notification.message = message;
          this.notification.type = type;
          setTimeout(() => (this.notification.message = ""), 4000);
        }
      }
    }).mount("#app");
  </script>

  <style>
    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.5s;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }
  </style>
</body>

  </html>
