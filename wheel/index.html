<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Fortune Wheel</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            casinoDark: "#0C0A16",
            casinoCard: "#151226",
            casinoPurple: "#A56BFF",
            casinoGlow: "#CFAAFF",
            successGreen: "#28a745",
            errorRed: "#dc3545",
            infoBlue: "#0d6efd"
          },
          fontFamily: { sans: ["Inter", "system-ui"] }
        }
      }
    };
  </script>

  <!-- Vue -->
  <script src="https://unpkg.com/vue@3.4.21/dist/vue.global.prod.js"></script>
</head>

<body class="bg-casinoDark text-white font-sans antialiased">
  <div id="app" class="min-h-screen p-6 pb-24">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div>
        <div class="text-lg font-semibold">Virtual Fortune Wheel</div>
        <div class="text-sm text-gray-400">Pick a number and spin!</div>
      </div>
    </div>

    <!-- Bet Input -->
    <div class="bg-casinoCard p-5 rounded-2xl shadow-lg mb-6">
      <label class="text-gray-300 text-sm">Enter Bet Amount (â‚¦)</label>
      <input type="number" v-model="betAmount"
        class="mt-2 w-full p-3 rounded-xl bg-casinoDark border border-gray-700 focus:border-casinoPurple outline-none"
        placeholder="1000" />

      <label class="text-gray-300 text-sm mt-4">Pick a Number (0â€“36)</label>
      <input type="number" v-model="selectedNumber"
        class="mt-2 w-full p-3 rounded-xl bg-casinoDark border border-gray-700 focus:border-casinoPurple outline-none"
        placeholder="17" min="0" max="36" />

      <label class="text-gray-300 text-sm mt-4">Select Odds</label>
      <div class="flex gap-3 mt-2">
        <button v-for="o in odds" :key="o" @click="selectedOdd=o"
          :class="['flex-1 py-2 rounded-xl font-semibold', selectedOdd===o ? 'bg-casinoPurple text-white' : 'bg-gray-700 text-gray-300']">
          X{{ o }}
        </button>
      </div>

      <button @click="spinWheel"
        class="w-full mt-5 py-3 rounded-full bg-casinoPurple text-white font-semibold">Spin Wheel</button>
    </div>

    <!-- Wheel Canvas -->
    <div class="relative bg-casinoCard p-5 rounded-2xl shadow-lg mb-6 flex justify-center items-center">
      <canvas ref="wheelCanvas" width="300" height="300"></canvas>
      <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-b-16 border-b-casinoPurple z-10"></div>
    </div>

    <!-- Result -->
    <div class="text-center text-2xl mt-4" v-if="rouletteResult !== null">
      ðŸŽ¯ Result: {{ rouletteResult }}
    </div>

    <!-- Notification -->
    <transition name="fade">
      <div v-if="notification.message"
        :class="['mt-4 p-4 rounded-lg text-white font-medium', notification.type === 'success' ? 'bg-successGreen' : notification.type === 'error' ? 'bg-errorRed' : 'bg-infoBlue']">
        {{ notification.message }}
      </div>
    </transition>

  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          token: "",
          betAmount: "",
          selectedNumber: "",
          odds: [2, 3, 4, 5],
          selectedOdd: 2,
          rouletteResult: null,
          notification: { message: "", type: "info" },
          spinning: false,
          wheelNumbers: Array.from({ length: 37 }, (_, i) => i),
          wheelColors: []
        };
      },
      mounted() {
        this.token = localStorage.getItem("casino_token");
        if (!this.token) {
          alert("Login required");
          window.location.href = "/login";
        }
        this.generateColors();
        this.drawWheel(0);
      },
      methods: {
        generateColors() {
          this.wheelColors = this.wheelNumbers.map(n => {
            if (n === 0) return "#28a745"; // green
            return n % 2 === 0 ? "#000000" : "#FF0000"; // black/red
          });
        },
        drawWheel(rotation) {
          const canvas = this.$refs.wheelCanvas;
          const ctx = canvas.getContext("2d");
          const center = canvas.width / 2;
          const radius = center - 5;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.translate(center, center);
          ctx.rotate(rotation);
          const sliceAngle = (2 * Math.PI) / 37;
          this.wheelNumbers.forEach((num, i) => {
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.arc(0, 0, radius, i * sliceAngle, (i + 1) * sliceAngle);
            ctx.fillStyle = this.wheelColors[i];
            ctx.fill();
            ctx.strokeStyle = "#fff";
            ctx.stroke();
            ctx.save();
            ctx.rotate(i * sliceAngle + sliceAngle / 2);
            ctx.translate(radius - 20, 0);
            ctx.rotate(Math.PI / 2);
            ctx.fillStyle = "#fff";
            ctx.font = "14px sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(num, 0, 0);
            ctx.restore();
          });
          ctx.restore();
        },
        async spinWheel() {
          if (this.spinning) return;
          if (!this.betAmount || this.betAmount < 100) return this.showNotification("Enter valid bet (min â‚¦100)", "error");
          if (this.selectedNumber === "" || this.selectedNumber < 0 || this.selectedNumber > 36) return this.showNotification("Pick number 0â€“36", "error");
          if (!this.selectedOdd) return this.showNotification("Select odds!", "error");

          this.spinning = true;
          this.showNotification("Debiting walletâ€¦", "info");

          // Debit wallet API
          const debitPayload = {
            token: this.token,
            amount: Number(this.betAmount),
            reference: "DEBIT" + Date.now(),
            description: "Fortune Wheel Bet"
          };
          try {
            const debitRes = await fetch("https://favour-amaaavl.xyz/api/fund/sub", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(debitPayload)
            });
            const debitData = await debitRes.json();
            if (!debitData.status) {
              this.spinning = false;
              return this.showNotification("Debit failed: " + (debitData.message || "Unknown error"), "error");
            }

            // Spin wheel animation
            const resultNumber = this.wheelNumbers[Math.floor(Math.random() * 37)];
            const sliceAngle = (2 * Math.PI) / 37;
            const spins = 6; // full spins
            const finalRotation = spins * 2 * Math.PI - resultNumber * sliceAngle - sliceAngle / 2;
            const duration = 5000;
            const startTime = performance.now();

            const animate = (time) => {
              let t = (time - startTime) / duration;
              if (t > 1) t = 1;
              const ease = 1 - Math.pow(1 - t, 3);
              const rotation = ease * finalRotation;
              this.drawWheel(rotation);
              if (t < 1) requestAnimationFrame(animate);
              else this.finishSpin(resultNumber);
            };
            requestAnimationFrame(animate);

          } catch (err) {
            this.spinning = false;
            this.showNotification("Request failed: " + err.message, "error");
          }
        },
        async finishSpin(resultNumber) {
          this.rouletteResult = resultNumber;
          const win = Number(this.selectedNumber) === resultNumber;

          if (win) {
            const winAmount = Number(this.betAmount) * this.selectedOdd;
            // Credit wallet API
            const creditPayload = {
              token: this.token,
              amount: winAmount,
              reference: "CREDIT" + Date.now(),
              description: `Fortune Wheel Win X${this.selectedOdd}`
            };
            try {
              const creditRes = await fetch("https://favour-amaaavl.xyz/api/fund/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(creditPayload)
              });
              const creditData = await creditRes.json();
              if (creditData.status) {
                this.showNotification(`ðŸŽ‰ You won â‚¦${winAmount}!`, "success");
              } else {
                this.showNotification("Credit failed: " + (creditData.message || ""), "error");
              }
            } catch (err) {
              this.showNotification("Credit request failed: " + err.message, "error");
            }
          } else {
            this.showNotification(`ðŸ˜ž You lost! Landed on ${resultNumber}`, "error");
          }
          this.spinning = false;
        },
        showNotification(message, type) {
          this.notification.message = message;
          this.notification.type = type;
          setTimeout(() => { this.notification.message = ""; }, 4000);
        }
      }
    }).mount("#app");
  </script>

  <style>
    .fade-enter-active,
    .fade-leave-active { transition: opacity 0.5s; }
    .fade-enter-from,
    .fade-leave-to { opacity: 0; }
  </style>
</body>

</html>
